<!DOCTYPE html>
<html>
<head>
  <title>Setup Profile</title>
  <link rel="stylesheet" href="style.css">

  <!-- Cropper CSS MUST be in head -->
  <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.css"/>
</head>
<body>

<h1 class="glow">PROFILE REQUIRED</h1>
<p>You are missing your profile picture.</p>

<div class="badge-container">
  <div class="badge-frame">
    <img src="badge.png" class="frame">
    <img id="preview" class="preview">
  </div>
</div>

<input type="file" id="imageInput">
<button onclick="saveProfile()">Save Profile</button>

<!-- Cropper JS at bottom -->
<script src="https://unpkg.com/cropperjs/dist/cropper.js"></script>

<script>
let cropper;
const input = document.getElementById("imageInput");
const preview = document.getElementById("preview");

input.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function() {
    preview.src = reader.result;

    // Destroy old cropper if exists
    if (cropper) {
      cropper.destroy();
    }

    cropper = new Cropper(preview, {
      aspectRatio: 1,
      viewMode: 1,
      dragMode: "move",
      autoCropArea: 1,
      background: false,
      zoomable: true,
      scalable: false,
      movable: true
    });
  };

  reader.readAsDataURL(file);
});

async function saveProfile() {
  if (!cropper) {
    alert("Select an image first.");
    return;
  }

  const canvas = cropper.getCroppedCanvas({
    width: 400,
    height: 400
  });

  const blob = await new Promise(resolve =>
    canvas.toBlob(resolve, "image/png")
  );

  const formData = new FormData();
  formData.append("image", blob);

  const res = await fetch("/upload-profile", {
    method: "POST",
    body: formData
  });

  if (res.ok) {
    window.location.href = "/chat";
  } else {
    alert("Upload failed");
  }
}
</script>

</body>
</html>
